#pragma once

#include <stdio.h>
#include <stdint.h>

using u64 = uint64_t;

const u64 p = 3, y = 1, w = 6;

constexpr bool __attribute__((aligned(64))) table[512] = {0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

inline u64 evolve(u64 a, u64 b, u64 c)
{
    // Extra birth on the right
    if (table[((a & 1) << 8) | ((b & 1) << 5) | ((c & 1) << 2)])
        return u64(-1);

    // Avoid boundary issues
    a <<= 1, b <<= 1, c <<= 1;

    u64 res = 0;
    for (int i = 0; i < 64; i++)
    {
        u64 A = (a >> i) & 7, B = (b >> i) & 7, C = (c >> i) & 7;
        res |= u64(table[(A << 6) | (B << 3) | C]) << i;
    }

    return res;
}

inline u64 mirror(u64 x)
{
    for (int i = 0; i < w; i++)
        x |= (((x >> i) & 1) << (2 * w - 1 - i));
    return x;
}

inline u64 ev2(u64 a, u64 b, u64 c)
{
    a = mirror(a), b = mirror(b), c = mirror(c);
    u64 s = evolve(a, b, c);
    if (s == -1) return -1;
    return s & ((u64(1) << w) - 1);
}

struct node
{
    u64 row;
    node *parent;
};

inline node *kth_parent(node *n, int k)
{
    for (int i = 0; i < k; i++)
        n = n -> parent;
    return n;
}

inline void output_row(u64 r)
{
    for (int i = 0; i < w; i++)
        std::printf("%c", "bo"[(r >> i) & 1]);
    std::printf("$");
}

inline u64 hash_node(node *n)
{
    u64 hash = 0;
    for (int i = 0; i < 2 * p; i++)
    {
        hash = (hash * 73 + (n -> row)) % 1000000007;
        n = n -> parent;
    }
    return hash;
}
